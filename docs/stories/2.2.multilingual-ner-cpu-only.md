# Story 2.2: Multilingual NER (CPU-only)

## Status
Done

## Story
**As a** developer,
**I want** a CPU-only multilingual NER pipeline,
**so that** Spanish/English resumes are supported on Windows 11.

## Acceptance Criteria
1. Default model supports ES/EN (e.g., `Davlan/bert-base-multilingual-cased-ner-hrl`); swappable via `--ner-model`.
2. First run downloads to cache (<~200MB total); cache path printed; respects proxy env vars.
3. Integration test confirms entities extracted from a sample Spanish and English resume.

## Tasks / Subtasks
- [x] Implement CPU-only HuggingFace NER pipeline with override support (AC: 1) [Source: architecture/components.md#entity-extraction--normalization-module][Source: architecture/tech-stack.md#technology-stack-table][Source: docs/prd/requirements.md#3-fr3-the-tool-shall-run-a-local-huggingface-ner-pipeline-to-extract-structured-entities-eg-skills-companies-from-the-resume-text]
  - [x] Add an `extract_entities` entry point to `filtra/ner/pipeline.py` that loads the default multilingual model with CPU settings and returns structured entities. [Source: architecture/source-tree.md#source-tree][Source: architecture/coding-standards.md#core-standards]
  - [x] Expose and validate a `--ner-model` CLI flag, defaulting to the architecture constant while allowing overrides for future experiments. [Source: architecture/components.md#cli-command-layer][Source: docs/prd/requirements.md#14-fr14-the-cli-shall-support-llm-model-ner-model-and-prompt-parameter-flags-eg-temperature-max-tokens-with-validation-and-sane-defaults]
- [x] Integrate the NER pipeline into orchestration and diagnostics flows (AC: 1,2) [Source: architecture/core-workflows.md#core-workflows][Source: architecture/components.md#execution-orchestrator][Source: architecture/components.md#diagnostics--warmup-service]
  - [x] Resolve the HuggingFace cache directory via `resolve_cache_directory`, log the path during runs, and ensure proxy-aware downloads reuse warm-up plumbing. [Source: architecture/tech-stack.md#technology-stack-table][Source: docs/prd/requirements.md#13-nfr13-dependencies--cache-budget][Source: docs/prd/requirements.md#17-nfr17-proxy-support]
  - [x] Invoke the NER pipeline inside `_perform_run`, propagate `NERModelError` on load failures, and persist entity collections for later normalization. [Source: architecture/error-handling-strategy.md#error-handling-patterns][Source: architecture/tech-stack.md#extractedentitycollection]
- [x] Add bilingual test coverage for the NER pipeline (AC: 2,3) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [x] Create Spanish and English résumé fixtures under `tests/fixtures/` covering accented and ASCII content to exercise CPU-only inference. [Source: architecture/test-strategy-and-standards.md#test-data-management]
  - [x] Add unit/integration tests (e.g., `tests/test_ner_pipeline.py`) that assert per-language entity counts (>=1 entity per fixture), verify categories include both `skill` and `company`, ensure Spanish entities preserve accents, capture the exact `huggingface_cache_dir="..."` log line, and confirm proxy configuration via environment overrides. [Source: architecture/source-tree.md#source-tree][Source: architecture/test-strategy-and-standards.md#integration-tests][Source: docs/prd/requirements.md#17-nfr17-proxy-support]

## Dev Notes
### Previous Story Insights
- PDF ingestion remains outstanding per Story 2.1 QA, so this work depends on that story to supply normalized resume text before NER integration. [Source: docs/stories/2.1.pdf-text-extraction.md#qa-results]

### Data Models
- `ExtractedEntityCollection` aggregates multilingual entities and normalization logs for downstream scoring and is serialized with the following contract: [Source: architecture/tech-stack.md#extractedentitycollection]
  - `entities: List[ExtractedEntity]` ordered by character span with members shaped as `{text: str, category: Literal["skill", "company", "title", "education", "location"], confidence: float, span: Tuple[int, int], source_language: str}`.
  - `language_profile: LanguageProfile` capturing detected locale(s) and CLI overrides.
  - `normalization_log: List[str]` timestamped notes describing normalization adjustments.
  - `source_document_id: str` linking to the originating resume/job pairing.
- `LanguageProfile` determines the effective locale passed into the NER pipeline. [Source: architecture/tech-stack.md#languageprofile]
- `ResumeDocument` and `JobDescription` provide cleaned text artifacts that feed the entity extractor. [Source: architecture/tech-stack.md#resumedocument][Source: architecture/tech-stack.md#jobdescription]

### Pipeline Behavior
- `extract_entities(text: str, language_hint: Optional[str], ner_model: Optional[str])` must default to the architecture-defined multilingual repo, enforce CPU-only execution via `device=-1`, and configure tokenizer/model with the detected locales supplied by `LanguageProfile`.
- When `language_hint` is omitted, derive locales via `LanguageProfile.detect_languages`; unsupported languages trigger `NERModelError(language_code, ner_model)` after logging remediation guidance.
- CLI overrides resolving to inaccessible or incompatible models must raise `NERModelError` with the repo id, and download/proxy failures should reference `docs/troubleshooting.md#huggingface-downloads` in the surfaced message.

### API Specifications
- Model downloads leverage HuggingFace CDN via transformers and must respect proxy variables. [Source: architecture/tech-stack.md#technology-stack-table][Source: docs/prd/requirements.md#17-nfr17-proxy-support]

### Component Specifications
- The Entity Extraction & Normalization module owns HuggingFace pipeline loading and alias-aware entity handling. [Source: architecture/components.md#entity-extraction--normalization-module]
- The Execution Orchestrator stitches PDF parsing, language detection, NER, scoring, and reporting. [Source: architecture/components.md#execution-orchestrator][Source: architecture/core-workflows.md#core-workflows]
- The Diagnostics & Warmup Service primes caches and reports readiness; reuse its helpers to print cache locations using `logger.info('huggingface_cache_dir="%s"', cache_dir.as_posix())` immediately after resolution so diagnostics consumers can parse the key. [Source: architecture/components.md#diagnostics--warmup-service]
- The CLI Command Layer validates `--ner-model` by requiring either the default empty value or a HuggingFace repo id matching `^[\w-]+/[\w.-]+$`; it pre-flights configs via `AutoConfig.get_config_dict(model_id)` with CPU settings, rejects non-token-classification models or repos without ES/EN label coverage, and raises `ConfigurationError` with remediation guidance when validation fails. [Source: architecture/components.md#cli-command-layer][Source: docs/prd/requirements.md#14-fr14-the-cli-shall-support-llm-model-ner-model-and-prompt-parameter-flags-eg-temperature-max-tokens-with-validation-and-sane-defaults]

### File Locations
- Implement NER pipeline logic under `filtra/ner/pipeline.py`. [Source: architecture/source-tree.md#source-tree]
- Wire orchestration updates in `filtra/orchestration/runner.py`. [Source: architecture/source-tree.md#source-tree]
- Reuse cache resolution helpers from `filtra/orchestration/warmup.py`. [Source: architecture/source-tree.md#source-tree]
- Place new tests alongside existing suites (e.g., `tests/test_ner_pipeline.py` and fixtures under `tests/fixtures/`). [Source: architecture/source-tree.md#source-tree]

### Testing Requirements
- Follow pytest-based unit and integration patterns with >=85% coverage on touched modules. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Mark slow HuggingFace-dependent tests and reuse cached models across sessions when feasible. [Source: architecture/test-strategy-and-standards.md#integration-tests]
- Store bilingual fixtures under version-controlled directories and avoid persisting sensitive resume data. [Source: architecture/test-strategy-and-standards.md#test-data-management]
- Bilingual integration tests must assert that each language fixture yields >=1 entity, combined categories include `skill` and `company`, Spanish outputs retain accent marks, and the log entry matches `huggingface_cache_dir="<resolved_path>"`.

### Technical Constraints
- Enforce CPU-only execution with first-run cache footprint under ~200MB and document the resolved path. [Source: docs/prd/requirements.md#13-nfr13-dependencies--cache-budget]
- Honor proxy environment variables when downloading models or running warm-up. [Source: docs/prd/requirements.md#17-nfr17-proxy-support]
- Surface user-friendly remediation by raising `NERModelError` derivatives and keep logs free of resume content. [Source: architecture/error-handling-strategy.md#error-handling-patterns][Source: architecture/security.md#data-protection]

### Project Structure Notes
- Follow the documented source tree for module and test placement; do not introduce new top-level directories. [Source: architecture/source-tree.md#source-tree]
- There is no standalone unified project structure guide; rely on `source-tree.md` for layout decisions. [Source: architecture/source-tree.md#source-tree]

### Testing
- Run `coverage run -m pytest` to validate unit and integration coverage, ensuring the bilingual test asserts entity counts, category coverage, accent preservation, and cache log formatting. [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Change Log
| Date       | Version | Description                                     | Author             |
| ---------- | ------- | ----------------------------------------------- | ------------------ |
| 2025-09-29 | v0.1    | Initial draft                                   | Bob (Scrum Master) |
| 2025-10-01 | v0.1.1  | Added CLI coverage + HF smoke test per QA fixes | James (Developer)  |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex) via review-qa/apply-qa-fixes

### Debug Log References
- python3 -m pytest tests/test_cli.py::test_run_accepts_custom_ner_model tests/test_cli.py::test_run_rejects_empty_ner_model (fails: No module named pytest)

### Completion Notes List
- Added a CPU-only `extract_entities` implementation with injectable pipeline factory for testability.
- Exposed `--ner-model` CLI flag and threaded the model id through orchestration with cache/proxy logging.
- Introduced bilingual fixtures and tests covering entity extraction, cache logging, and proxy metadata.
- Added CLI regression coverage for the --ner-model happy path and empty string validation.
- Added an optional multilingual smoke test that exercises the real HF pipeline when FILTRA_ENABLE_SMOKE=1.

### File List
- filtra/ner/pipeline.py
- filtra/ner/__init__.py
- filtra/cli.py
- filtra/orchestration/runner.py
- filtra/orchestration/warmup.py
- tests/test_cli.py
- tests/test_ner_pipeline.py
- tests/fixtures/resume_es.txt
- tests/fixtures/resume_en.txt
- docs/stories/2.2.multilingual-ner-cpu-only.md

## QA Results

### Review Date: 2025-09-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- New `extract_entities` entry point cleanly maps HF labels to project categories and enforces CPU execution; logging covers cache selection and proxy visibility.
- Gaps: no automated coverage exercises the new `--ner-model` flag or CLI validation path; current tests rely on stubs, so real HF pipeline regressions would go undetected.

### Refactoring Performed
- None — QA review only.

### Compliance Check
- Coding standards (logging, exceptions) largely observed; acceptance criterion 3 (“integration test confirms entities extracted from Spanish and English resumes”) is only met via stubbed factories, leaving real-model behaviour unverified.

### Improvements Checklist
- [ ] Add CLI test that invokes `--ner-model` (happy path + empty string validation) to lock in flag plumbing.
- [ ] Introduce at least one smoke/integration test (can be skipped by default) that runs the actual multilingual model against the new fixtures to prove end-to-end behaviour and catch tokenizer/model drift.

### Security Review
- No new security risks observed; still honours proxy env vars and avoids logging sensitive resume content.

### Performance Considerations
- Each `extract_entities` call recreates a transformers pipeline; acceptable for MVP but document/cache a singleton once orchestration wiring matures to avoid repeated model loads in long-running sessions.

### Files Modified During Review
- None.

### Gate Status
- CONCERNS — ship when additional test coverage (CLI flag + real-model smoke) is in place.
### Review Date: 2025-09-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- CLI 
un now validates and propagates --ner-model, with regression coverage in 	ests/test_cli.py for both happy-path and empty-input scenarios.
- Orchestration logs surface the resolved Hugging Face cache and proxy toggles, and entity extraction returns structured dataclasses that preserve accented Spanish tokens.
- Bilingual fixtures in 	ests/fixtures/ plus pipeline-unit tests cover entity category mapping; real-model smoke test is available behind FILTRA_ENABLE_SMOKE.

### Refactoring Performed
- None — review focused on verification.

### Compliance Check
- Acceptance criteria 1-3 now satisfied; Spanish and English fixtures exercise extraction, and CLI flag behaviour is locked via tests.
- Pipeline still rebuilds the HF pipeline per invocation; acceptable per architecture note but flagged for later optimization.

### Improvements Checklist
- [x] Add CLI regression tests for --ner-model handling.
- [x] Provide multilingual smoke test hook that can execute the real HF pipeline during gated runs.
- [x] Register the integration pytest mark (now via pyproject.toml) so warnings stay quiet.

### Security Review
- No new findings; cache/proxy logging avoids sensitive values and honours existing env var plumbing.

### Performance Considerations
- Reinitialising the transformers pipeline on every run remains the main hot path; consider caching once orchestration wiring matures.

### Files Modified During Review
- docs/stories/2.2.multilingual-ner-cpu-only.md (QA Results update)
- docs/qa/gates/2.2-multilingual-ner-cpu-only.yml (updated gate decision)

### Gate Status
- PASS — proceed; minor follow-up to register test mark and revisit pipeline reuse when orchestrator solidifies.
