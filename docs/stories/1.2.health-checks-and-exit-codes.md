# Story 1.2: Health Checks and Exit Codes

## Status
Approved

## Story
**As a** user,
**I want** clear health checks and exit codes,
**so that** failures are actionable during demos.

## Acceptance Criteria
1. Implement explicit exit codes (0 success, 2 invalid input, 3 parse error, 4 NER error, 5 LLM error, 6 timeout) wired through main.
2. Add a `--health` flag that validates Python version, env var presence, and prints model/API readiness summary without network calls.
3. Errors include remediation text (e.g., missing `OPENROUTER_API_KEY`).

## Tasks / Subtasks
- [ ] Wire deterministic exit code mapping through CLI and orchestrator (AC: 1,3)
  - [ ] Define shared exit code constants aligned with PRD requirements and expose them via the CLI entrypoint so `python -m filtra run` returns the correct status codes. [Source: architecture/components.md#cli-command-layer][Source: architecture/error-handling-strategy.md#business-logic-errors]
  - [ ] Update the execution orchestrator to translate domain exceptions (`InputValidationError`, `PdfExtractionError`, `NERModelError`, `LLMRequestError`, timeout) into the mapped exit codes and structured log records. [Source: architecture/components.md#execution-orchestrator][Source: architecture/error-handling-strategy.md#general-approach]
  - [ ] Extend `tests/test_cli.py` (or new orchestration tests) to cover success and failure flows asserting exit codes 0/2/3/4/5/6 and quiet-mode logging. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- [ ] Implement `--health` diagnostics flag with offline readiness summary (AC: 2)
  - [ ] Add a Typer option or subcommand invoking the Diagnostics & Warmup service to report Python/runtime version checks, required env vars, and cache locations without performing outbound requests. [Source: architecture/components.md#diagnostics--warmup-service][Source: architecture/core-workflows.md#core-workflows]
  - [ ] Validate presence of secrets (`OPENROUTER_API_KEY`) and proxy configuration, returning remediation hints when missing. [Source: architecture/security.md#secrets-management][Source: architecture/security.md#authentication--authorization]
  - [ ] Surface HuggingFace cache directory and dependency pin information to reassure demo readiness, reusing config loader helpers where available. [Source: architecture/tech-stack.md#technology-stack-table][Source: architecture/source-tree.md#source-tree]
  - [ ] Cover the `--health` flow with unit tests (and optional smoke test) ensuring no network calls occur and outputs list each check with PASS/FAIL status. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- [ ] Provide user-facing remediation guidance for failure scenarios (AC: 3)
  - [ ] Standardize error-to-remediation messaging in orchestrator error handlers so CLI failures print concise next steps (e.g., set env var, run warm-up). [Source: architecture/error-handling-strategy.md#business-logic-errors][Source: architecture/components.md#execution-orchestrator]
  - [ ] Document the exit code matrix and remediation examples in README troubleshooting to keep onboarding aligned with health check output. [Source: architecture/infrastructure-and-deployment.md#deployment-strategy][Source: architecture/coding-standards.md#core-standards]
  - [ ] Ensure logging pipeline suppresses sensitive values while including remediation text, and add regression tests to guard against accidental secret exposure. [Source: architecture/coding-standards.md#critical-rules][Source: architecture/security.md#data-protection]
  - [ ] Update `docs/architecture/error-handling-strategy.md` with the new exit code map.

## Dev Notes
### Previous Story Insights
- CLI scaffolding already exposes Typer-based `run` and `warm-up` commands with Rich logging and baseline argument validation. [Source: docs/stories/1.1.cli-project-scaffold.md#tasks--subtasks]
- Existing CLI tests assert help output, quiet mode, and argument errors; extend these cases rather than creating parallel fixtures. [Source: docs/stories/1.1.cli-project-scaffold.md#dev-agent-record]

### Data Models
- `EvaluationRun` snapshots CLI options and processing metadata; propagate exit code and health diagnostics results into this record for auditability. [Source: architecture/tech-stack.md#evaluationrun]
- Report rendering links to `WarmupResult` when preflight checks run before execution, so health summaries should map to that structure for reuse in future reporting. [Source: architecture/tech-stack.md#reportenvelope]

### API Specifications
- OpenRouter access remains encapsulated by `filtra.llm.client`; health checks must avoid live HTTP calls but can validate configuration prerequisites. [Source: architecture/components.md#llm-integration-gateway][Source: architecture/external-apis.md#openrouter-api]

### Component Specifications
- Execution Orchestrator centralizes error handling and must emit structured exit codes plus remediation text. [Source: architecture/components.md#execution-orchestrator]
- Diagnostics & Warmup Service is responsible for readiness checks; reuse its interfaces when powering the new `--health` flag for consistency. [Source: architecture/components.md#diagnostics--warmup-service]
- CLI Command Layer should keep subcommand ergonomics PowerShell-friendly while printing summaries compatible with quiet mode and Rich formatting. [Source: architecture/components.md#cli-command-layer]

### File Locations
- CLI integrations live in `filtra/cli.py` and delegate to orchestrator and diagnostics modules per the defined source tree. [Source: architecture/source-tree.md#source-tree]
- Exit code handling and remediation text should be centralized under `filtra/orchestration/runner.py` (or equivalent) with shared utilities in `filtra/utils/logging.py`. [Source: architecture/source-tree.md#source-tree]
- Tests for CLI and health checks belong in `tests/test_cli.py` (unit) and future integration suites under `tests/integration/`. [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Testing Requirements
- Achieve >=85% coverage on updated CLI/orchestrator modules, mocking external APIs and ensuring proxy env vars are respected. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Add regression cases for timeout, NER, and LLM failures verifying exit codes 3/4/5/6 and remediation text content. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Consider an integration smoke test invoking `python -m filtra --health` using pytest subprocess fixtures to assert offline execution. [Source: architecture/test-strategy-and-standards.md#integration-tests]

### Technical Constraints
- Continue targeting Python 3.10.11 with Typer 0.12.3 and Click 8.1.7 to preserve Windows compatibility. [Source: architecture/tech-stack.md#technology-stack-table]
- Maintain Rich logging format while suppressing secrets; use `--quiet` to downgrade to WARN per coding standards. [Source: architecture/coding-standards.md#core-standards]
- Health checks must respect proxy environment variables and reuse `%LOCALAPPDATA%/filtra/models` for cache reporting to align with Windows expectations. [Source: architecture/tech-stack.md#technology-stack-table][Source: architecture/security.md#api-security]

### Project Structure Notes
- Architecture error-handling guidance lists exit codes 1â€“4, while the PRD mandates 0/2/3/4/5/6; reconcile by updating architecture documentation once implementation lands. [Source: architecture/error-handling-strategy.md#business-logic-errors]

## Testing
- Pending implementation; follow Testing Requirements once tasks complete.

## Change Log
| Date       | Version | Description           | Author             |
| ---------- | ------- | --------------------- | ------------------ |
| 2025-09-26 | 0.1     | Initial draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results




