# Story 2.1: PDF Text Extraction

## Status
Ready for Review

## Story
**As a** developer,
**I want** reliable PDF-to-text extraction,
**so that** resumes produce clean text for NER and LLM.

## Acceptance Criteria
1. Implement PDF parsing with detection of non-text/encrypted PDFs; on detection, fail fast with actionable error (OCR out-of-scope per NFR12).
2. Normalize whitespace and newlines; ensure utf-8 output (utf-8-sig read, cp1252 fallback per NFR15).
3. Unit tests cover typical text PDFs and non-text PDFs; exit code 3 on parse errors.
4. Preserve existing plain-text (.txt) résumé ingestion while adding PDF support so the CLI continues honoring both input types.

## Tasks / Subtasks
- [x] Create the PDF loader module at `filtra/ingestion/pdf_loader.py` exposing `extract_text` (AC: 1,2) [Source: architecture/components.md#pdf-processing-module][Source: architecture/tech-stack.md#technology-stack-table]
  - [x] Implement text extraction with utf-8-sig read, cp1252 fallback, and whitespace/newline normalization (AC: 2) [Source: architecture/components.md#pdf-processing-module][Source: architecture/coding-standards.md#core-standards]
  - [x] Detect encrypted and image-only PDFs, raising `PdfExtractionError` with remediation messaging while avoiding sensitive logging (AC: 1) [Source: architecture/error-handling-strategy.md#error-handling-patterns][Source: architecture/security.md#data-protection]
- [x] Integrate the loader with the orchestration pipeline and CLI error handling (AC: 1,3) [Source: architecture/components.md#execution-orchestrator][Source: architecture/components.md#cli-command-layer]
  - [x] Update `filtra/orchestration/runner.py` to invoke the loader, capture metadata, and propagate `PdfExtractionError` to exit code 3 (AC: 1,3) [Source: architecture/core-workflows.md#core-workflows][Source: architecture/error-handling-strategy.md#error-handling-patterns]
  - [x] Surface remediation guidance through `filtra/cli.py` without exposing resume contents, ensuring deterministic exit code 3 on parse failure (AC: 3) [Source: architecture/coding-standards.md#critical-rules][Source: architecture/components.md#cli-command-layer]
- [x] Expand automated coverage for success and failure paths (AC: 3) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [x] Add unit tests in `tests/test_pdf_loader.py` covering text, encrypted, and image-only PDFs, validating normalization and failure signalling (AC: 2,3) [Source: architecture/test-strategy-and-standards.md#test-data-management][Source: architecture/source-tree.md#source-tree]
  - [x] Add integration/CLI tests (e.g., `tests/integration/test_cli_pdf.py`) asserting exit code 3 and remediation messaging for failure scenarios (AC: 3) [Source: architecture/test-strategy-and-standards.md#integration-tests][Source: architecture/components.md#cli-command-layer]
  - [x] Add regression coverage to confirm `.txt` resume ingestion still succeeds alongside PDF flows (AC: 4) [Source: docs/prd/requirements.md#1-fr1-the-tool-shall-accept-a-single-resume-in-pdf-format-and-a-job-description-in-plain-text-file-via-cli-arguments][Source: architecture/core-workflows.md#core-workflows]

## Dev Notes
### Previous Story Insights
- No specific guidance found in prior story docs applicable to PDF extraction.

### Data Models
- No specific guidance found in architecture docs.

### API Specifications
- No specific guidance found in architecture docs.

### Component Specifications
- PDF Processing module owns `extract_text` and `inspect_metadata`, wrapping `pypdf` to cleanly extract resume text and detect malformed assets. [Source: architecture/components.md#pdf-processing-module]
- Execution Orchestrator composes the end-to-end pipeline and must consume the PDF extraction output before language detection and NER stages. [Source: architecture/components.md#execution-orchestrator][Source: architecture/high-level-architecture.md#high-level-overview]
- CLI layer handles user-facing messaging and delegates parse failures through the orchestrator while observing logging discipline. [Source: architecture/components.md#cli-command-layer][Source: architecture/coding-standards.md#core-standards]
- CLI must branch on file type, invoking the PDF loader for `.pdf` inputs while retaining the current plain-text ingestion path for `.txt` résumés. [Source: docs/prd/requirements.md#1-fr1-the-tool-shall-accept-a-single-resume-in-pdf-format-and-a-job-description-in-plain-text-file-via-cli-arguments][Source: architecture/core-workflows.md#core-workflows]
- Reuse `LoadedDocument` and `normalize_newlines` from `filtra/utils/io.py` when building `extract_text` to keep metadata handling and newline normalization consistent. [Source: filtra/utils/io.py][Source: docs/architecture/source-tree.md#source-tree]

### File Locations
- PDF ingestion logic resides at `filtra/ingestion/pdf_loader.py` per source tree layout. [Source: architecture/source-tree.md#source-tree]
- Orchestrator updates belong in `filtra/orchestration/runner.py` alongside error handling wiring. [Source: architecture/source-tree.md#source-tree]
- CLI integration changes belong in `filtra/cli.py` to expose remediation messaging. [Source: architecture/components.md#cli-command-layer]
- Tests for parsing live in `tests/test_pdf_loader.py`, with integration or CLI checks under `tests/integration/` or `tests/test_cli.py` as appropriate. [Source: architecture/source-tree.md#source-tree][Source: architecture/test-strategy-and-standards.md#integration-tests]

### Testing Requirements
- Use pytest (8.3.2) with pytest-mock for unit coverage, maintaining ≥85% coverage for touched modules. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Provide deterministic fixtures under `tests/fixtures/` for encrypted and image-based PDFs, covering success plus failure paths. [Source: architecture/test-strategy-and-standards.md#test-data-management]
- Unit tests must assert `PdfExtractionError` for encrypted and image-only PDFs and validate the cp1252 fallback behaviour. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Integration or CLI tests must verify exit code 3, remediation messaging, and logging discipline for failure scenarios (encrypted/image-only) without external services. [Source: architecture/test-strategy-and-standards.md#integration-tests]

### Technical Constraints
- All module-level errors must raise `FiltraError` derivatives (`PdfExtractionError`) so the orchestrator can translate them into exit codes. [Source: architecture/error-handling-strategy.md#error-handling-patterns]
- Logging must avoid leaking resume content, rely on structured logging, and respect `--quiet` semantics. [Source: architecture/coding-standards.md#core-standards]
- Encoding handling must favour utf-8-sig with cp1252 fallback to satisfy Windows NFR15 expectations. [Source: docs/prd/requirements.md#nfr15-windows-quotingencoding]
- Resume parsing should remain in-memory without persisting artifacts to disk to honour security guidance. [Source: architecture/security.md#data-protection]

### Project Structure Notes
- Keep new fixtures and helpers inside existing `tests/` hierarchy; do not introduce new top-level directories. [Source: architecture/source-tree.md#source-tree]
- Reuse configuration constants via existing utility modules instead of duplicating paths or settings. [Source: architecture/components.md#configuration-persistence-layer]

### Testing
- Run `coverage run -m pytest` to validate unit plus integration suites and meet coverage targets, ensuring the CLI failure path test asserts exit code 3. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Ensure CLI tests rely on mocked inputs and avoid external network calls, following integration guidance, and include encrypted/image-only PDF fixtures. [Source: architecture/test-strategy-and-standards.md#integration-tests]

## Change Log
| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-09-28 | v0.1    | Initial draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

- GPT-5 (Codex)

### Debug Log References

- No runtime debug log entries captured (.ai/debug-log.md unchanged).

### Completion Notes List

- Implemented PDF loader with normalization and encrypted/image-only detection.
- Routed orchestration/CLI to the loader with deterministic parse error handling.
- Added unit and CLI coverage for PDF flows plus .txt regression.

### File List

- filtra/ingestion/__init__.py
- filtra/ingestion/pdf_loader.py
- filtra/orchestration/runner.py
- filtra/utils/io.py
- tests/test_cli.py
- tests/test_pdf_loader.py

## QA Results

### Review Date: 2025-09-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation for PDF text extraction is absent, so the pipeline still depends on plain-text loading. Required modules such as filtra/ingestion/pdf_loader.py and orchestration wiring, error handling, and CLI integration were not delivered, leaving all acceptance criteria unmet. Story remains in Draft status and cannot progress to Done without core functionality.

### Refactoring Performed

- _None._

### Compliance Check

- Coding Standards: ✗ No implementation to assess; required module missing.
- Project Structure: ✗ Expected ingestion package at filtra/ingestion/ is absent.
- Testing Strategy: ✗ No unit or integration coverage for parsing scenarios.
- All ACs Met: ✗ AC1–AC3 not satisfied; loader, normalization, and exit-code mapping never implemented.

### Improvements Checklist

- [ ] Add filtra/ingestion/pdf_loader.py that detects encrypted/image-only PDFs and raises PdfExtractionError with remediation guidance (AC1).
- [ ] Normalise whitespace/newlines and emit UTF-8 text with cp1252 fallback within the loader (AC2).
- [ ] Wire the loader into orchestration/CLI, propagating PdfExtractionError to exit code 3 with user-facing remediation messaging (AC1, AC3).
- [ ] Extend tests/test_pdf_loader.py (and related fixtures) plus CLI/integration tests to cover text, encrypted, and image-only PDFs including exit code 3 validation (AC3).
- [ ] Update the story File List once implementation and tests are in place.

### Security Review

No implementation exists to evaluate. Current text-only loader risks misprocessing binary PDFs and exposing unreadable content without the required remediation messaging.

### Performance Considerations

Not assessed; functionality missing.

### Files Modified During Review

- None

### Gate Status

Gate: FAIL → docs/qa/gates/2.1-pdf-text-extraction.yml
Risk profile: docs/qa/assessments/2.1-risk-20250928.md (not generated)
NFR assessment: docs/qa/assessments/2.1-nfr-20250928.md (not generated)

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)



### Review Date: 2025-09-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- PDF loader normalizes whitespace per page and rejects encrypted or image-only resumes with remediation guidance.
- Orchestration and CLI route `.pdf` inputs through the loader and translate `PdfExtractionError` into exit code 3 with user-facing messaging.
- Implementation reuses `LoadedDocument`, `normalize_newlines`, and `format_display_path` utilities to stay aligned with existing patterns.

### Refactoring Performed

- _None._

### Compliance Check

- Coding Standards: ✓ Module layout, logging discipline, and path scrubbing match architecture guidance.
- Project Structure: ✓ New ingestion package and tests align with the documented source tree.
- Testing Strategy: ✓ Unit and CLI suites cover text, encrypted, and image-only resumes plus `.txt` regression.
- All ACs Met: ✓ AC1-AC4 validated through automated tests and runtime behaviour.

### Testing Evidence

- `pytest` (entire suite, 32 tests) – verifies pdf loader unit cases and CLI exit-code 3 flow.

### Improvements Checklist

- [x] Detect encrypted/image-only PDFs and raise `PdfExtractionError` with remediation guidance (AC1) — `filtra/ingestion/pdf_loader.py`, `tests/test_pdf_loader.py`.
- [x] Normalize whitespace/newlines and emit UTF-8 output (AC2) — `filtra/ingestion/pdf_loader.py`.
- [x] Propagate parse failures to exit code 3 with user messaging (AC1, AC3) — `filtra/orchestration/runner.py`, `filtra/cli.py`, `tests/test_cli.py`.
- [x] Preserve `.txt` ingestion alongside the PDF flow (AC4) — regression assertions in `tests/test_cli.py`.

### Security Review

- PASS – filenames are sanitized via `format_display_path`, and non-text PDFs are rejected without logging sensitive page content.

### Performance Considerations

- PASS – pypdf iterates pages once; normalization remains linear in resume length and suitable for CLI usage.

### Files Modified During Review

- docs/qa/gates/2.1-pdf-text-extraction.yml (updated gate decision).

### Gate Status

Gate: PASS → docs/qa/gates/2.1-pdf-text-extraction.yml
Risk profile: docs/qa/assessments/2.1-risk-20250929.md (not generated)
NFR assessment: docs/qa/assessments/2.1-nfr-20250929.md (not generated)

### Recommended Status

[✓ Ready for Done - Implementation meets QA requirements]
(Story owner decides final status)


