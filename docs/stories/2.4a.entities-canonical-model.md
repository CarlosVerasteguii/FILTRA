# Story 2.4a: Canonical Entity Data Model

## Status
Approved

## Story
**As a** developer,
**I want** the extraction pipeline to emit canonical entities with document context,
**so that** reporting and downstream analysis can display counts, sources, and snippets without re-reading source files.

## Acceptance Criteria
1. Introduce `EntityOccurrence` and `CanonicalEntity` dataclasses and evolve `ExtractedEntityCollection` to expose `occurrences`, `canonical_entities`, and a backwards-compatible `entities` alias.
2. filtra/ner/pipeline.py populates each occurrence with span, document role/display, raw text, placeholder canonical text, confidence, context snippet, and language before normalization. Context snippets must capture +/-40 characters around the entity, avoid extra padding at file boundaries, and include an ellipsis (...) whenever text is trimmed.
3. filtra/ner/normalization.py groups occurrences deterministically (category + folded canonical text), updates canonical labels, computes ordered contexts/sources respecting ingestion_index order (alphabetical only for ties), and records collection-level totals in the normalization log.
4. filtra/orchestration/runner.py merges per-document occurrences, assigns sequential ingestion_index values as it preserves ingestion order, and invokes normalization once to produce the enriched collection.
5. Unit/integration tests cover context snippet helpers, alias compatibility via the `entities` alias, document ordering, and multi-document aggregation edge cases.

## Tasks / Subtasks
- [ ] Define enriched entity data classes and collection contract (AC: 1) [Source: architecture/tech-stack.md#entityoccurrence][Source: architecture/tech-stack.md#canonicalentity][Source: architecture/tech-stack.md#extractedentitycollection]
  - [ ] Create `filtra/ner/models.py` to host the `EntityOccurrence`, `CanonicalEntity`, and updated `ExtractedEntityCollection` dataclasses with serialization-friendly defaults. Include an `ingestion_index: int` field on `EntityOccurrence` so downstream stages can rely on ingestion ordering. (AC: 1)
  - [ ] Maintain a deprecated-but-working `entities` alias that mirrors `canonical_entities` until downstream callers migrate. (AC: 1)
- [ ] Emit enriched occurrences in the NER pipeline (AC: 2) [Source: architecture/core-workflows.md#entity-processing-flow][Source: architecture/components.md#entity-extraction--normalization-module]
  - [ ] Refactor `extract_entities` to accept document metadata inputs and to call a reusable `build_context_snippet(text, span)` helper sourced from the shared utilities module. Ensure the helper is invoked with the +/-40 character snippet contract so pipelines produce consistent previews. (AC: 2)
  - [ ] Implement `build_context_snippet` in `filtra/utils/text.py` (create the module if needed) so future features can reuse the shared helper. The helper must trim to +/-40 characters around the span, skip padding when the span touches the boundaries, and return ellipses only when text is trimmed. (AC: 2)
  - [ ] Ensure `convert_predictions` (and equivalents) populate span offsets, raw text, canonical placeholder, confidence, document role/display, context snippet, and language code. (AC: 2)
- [ ] Normalize deterministically across documents (AC: 3) [Source: architecture/components.md#entity-extraction--normalization-module][Source: architecture/test-strategy-and-standards.md#canonical-entity-coverage]
  - [ ] Group occurrences by (category, canonical_text.casefold()), update canonical labels, and compute ordered contexts and sources keyed by ingestion order then alphabetical ties. (AC: 3)
  - [ ] Append normalization log messages summarizing totals, document counts, and notable alias merges without leaking raw resume text. (AC: 3)
- [ ] Merge occurrences prior to normalization in orchestration (AC: 4) [Source: architecture/core-workflows.md#entity-processing-flow]
  - [ ] Update the orchestrator to call the pipeline per document, concatenate occurrences while tracking original document order, and run normalization once. Assign `ingestion_index` sequentially during concatenation so normalization can preserve ordering metadata. (AC: 4)
  - [ ] Persist ordering metadata so reporting can render stable tables regardless of processing order. (AC: 4)
- [ ] Deliver regression coverage (AC: 5) [Source: architecture/test-strategy-and-standards.md#canonical-entity-coverage]
  - [ ] Add unit tests under `tests/ner/` (create the package if needed) for the context snippet helper, alias compatibility via the `entities` alias, and deterministic ordering across locales. (AC: 5)
  - [ ] Extend integration tests to assert multi-document aggregation, canonical counts, and normalization log summaries. (AC: 5)

## Dev Notes
- Story 2.3 introduced normalization/dedup with simple entity tuples; this story replaces that contract with canonical aggregates while keeping the alias compatibility path alive until reporting migrates. [Source: docs/stories/2.3.entity-normalization-and-dedup.md#dev-notes]
- Coordinate with Story 2.4b so the CLI can surface the richer metadata once reporting consumes it. [Source: docs/stories/2.4b.cli-reporting-modes.md]
- Canonical model quick reference: `EntityOccurrence` captures span offsets, raw text, confidence, document role/display, language, and context snippet; `CanonicalEntity` aggregates canonical text, ordered contexts, alias set, and source documents; `ExtractedEntityCollection` exposes `occurrences`, `canonical_entities`, and the backwards-compatible `entities` alias.
- Ensure ``ExtractedEntityCollection`` continues to propagate the existing ``language_profile`` and ``normalization_log`` fields after the expansions.

## Testing
- Unit tests must live in `tests/ner/` (create the directory if it does not exist) and cover occurrence construction, canonical grouping, and alias compatibility. [Source: architecture/source-tree.md#source-tree]
- Integration tests extend the root `tests/` suite (e.g., `tests/test_normalization.py`) to ensure orchestration merges per-document entities once and that normalization logs summarize counts without leaking resume text. [Source: architecture/test-strategy-and-standards.md#canonical-entity-coverage]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
