# Story 2.4a: Canonical Entity Data Model

## Status
Done

## Story
**As a** developer,
**I want** the extraction pipeline to emit canonical entities with document context,
**so that** reporting and downstream analysis can display counts, sources, and snippets without re-reading source files.

## Acceptance Criteria
1. Introduce `EntityOccurrence` and `CanonicalEntity` dataclasses and evolve `ExtractedEntityCollection` to expose `occurrences`, `canonical_entities`, and a backwards-compatible `entities` alias.
2. filtra/ner/pipeline.py populates each occurrence with span, document role/display, raw text, placeholder canonical text, confidence, context snippet, and language before normalization. Context snippets must capture +/-40 characters around the entity, avoid extra padding at file boundaries, and include an ellipsis (...) whenever text is trimmed.
3. filtra/ner/normalization.py groups occurrences deterministically (category + folded canonical text), updates canonical labels, computes ordered contexts/sources respecting ingestion_index order (alphabetical only for ties), and records collection-level totals in the normalization log.
4. filtra/orchestration/runner.py merges per-document occurrences, assigns sequential ingestion_index values as it preserves ingestion order, and invokes normalization once to produce the enriched collection.
5. Unit/integration tests cover context snippet helpers, alias compatibility via the `entities` alias, document ordering, and multi-document aggregation edge cases.

## Tasks / Subtasks
- [x] Define enriched entity data classes and collection contract (AC: 1) [Source: architecture/tech-stack.md#entityoccurrence][Source: architecture/tech-stack.md#canonicalentity][Source: architecture/tech-stack.md#extractedentitycollection]
  - [x] Create `filtra/ner/models.py` to host the `EntityOccurrence`, `CanonicalEntity`, and updated `ExtractedEntityCollection` dataclasses with serialization-friendly defaults. Include an `ingestion_index: int` field on `EntityOccurrence` so downstream stages can rely on ingestion ordering. (AC: 1)
  - [x] Maintain a deprecated-but-working `entities` alias that mirrors `canonical_entities` until downstream callers migrate. (AC: 1)
- [x] Emit enriched occurrences in the NER pipeline (AC: 2) [Source: architecture/core-workflows.md#entity-processing-flow][Source: architecture/components.md#entity-extraction--normalization-module]
  - [x] Refactor `extract_entities` to accept document metadata inputs and to call a reusable `build_context_snippet(text, span)` helper sourced from the shared utilities module. Ensure the helper is invoked with the +/-40 character snippet contract so pipelines produce consistent previews. (AC: 2)
  - [x] Implement `build_context_snippet` in `filtra/utils/text.py` (create the module if needed) so future features can reuse the shared helper. The helper must trim to +/-40 characters around the span, skip padding when the span touches the boundaries, and return ellipses only when text is trimmed. (AC: 2)
  - [x] Ensure `convert_predictions` (and equivalents) populate span offsets, raw text, canonical placeholder, confidence, document role/display, context snippet, and language code. (AC: 2)
- [x] Normalize deterministically across documents (AC: 3) [Source: architecture/components.md#entity-extraction--normalization-module][Source: architecture/test-strategy-and-standards.md#canonical-entity-coverage]
  - [x] Group occurrences by (category, canonical_text.casefold()), update canonical labels, and compute ordered contexts and sources keyed by ingestion order then alphabetical ties. (AC: 3)
  - [x] Append normalization log messages summarizing totals, document counts, and notable alias merges without leaking raw resume text. (AC: 3)
- [x] Merge occurrences prior to normalization in orchestration (AC: 4) [Source: architecture/core-workflows.md#entity-processing-flow]
  - [x] Update the orchestrator to call the pipeline per document, concatenate occurrences while tracking original document order, and run normalization once. Assign `ingestion_index` sequentially during concatenation so normalization can preserve ordering metadata. (AC: 4)
  - [x] Persist ordering metadata so reporting can render stable tables regardless of processing order. (AC: 4)
- [x] Deliver regression coverage (AC: 5) [Source: architecture/test-strategy-and-standards.md#canonical-entity-coverage]
  - [x] Add unit tests under `tests/ner/` (create the package if needed) for the context snippet helper, alias compatibility via the `entities` alias, and deterministic ordering across locales. (AC: 5)
  - [x] Extend integration tests to assert multi-document aggregation, canonical counts, and normalization log summaries. (AC: 5)

## Dev Notes
- Story 2.3 introduced normalization/dedup with simple entity tuples; this story replaces that contract with canonical aggregates while keeping the alias compatibility path alive until reporting migrates. [Source: docs/stories/2.3.entity-normalization-and-dedup.md#dev-notes]
- Coordinate with Story 2.4b so the CLI can surface the richer metadata once reporting consumes it. [Source: docs/stories/2.4b.cli-reporting-modes.md]
- Canonical model quick reference: `EntityOccurrence` captures span offsets, raw text, confidence, document role/display, language, and context snippet; `CanonicalEntity` aggregates canonical text, ordered contexts, alias set, and source documents; `ExtractedEntityCollection` exposes `occurrences`, `canonical_entities`, and the backwards-compatible `entities` alias.
- Ensure ``ExtractedEntityCollection`` continues to propagate the existing ``language_profile`` and ``normalization_log`` fields after the expansions.

## Testing
- Unit tests must live in `tests/ner/` (create the directory if it does not exist) and cover occurrence construction, canonical grouping, and alias compatibility. [Source: architecture/source-tree.md#source-tree]
- Integration tests extend the root `tests/` suite (e.g., `tests/test_normalization.py`) to ensure orchestration merges per-document entities once and that normalization logs summarize counts without leaking resume text. [Source: architecture/test-strategy-and-standards.md#canonical-entity-coverage]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex)

### Debug Log References
- pytest tests/ner tests/test_ner_pipeline.py tests/test_normalization.py

### Completion Notes List
- Introduced canonical entity dataclasses and extracted occurrence model in filtra/ner/models.py.
- Refactored pipeline, normalization, and orchestration to emit, merge, and canonicalize enriched occurrences with ordering metadata.
- Added unit/integration coverage for context snippets, alias compatibility, and multi-document aggregation.

### File List
- filtra/ner/models.py
- filtra/ner/__init__.py
- filtra/ner/pipeline.py
- filtra/ner/normalization.py
- filtra/orchestration/runner.py
- filtra/utils/text.py
- tests/test_cli.py
- tests/test_ner_pipeline.py
- tests/test_normalization.py
- tests/ner/__init__.py
- tests/ner/test_models.py
- tests/ner/test_text_utils.py

## QA Results
### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Data classes in `filtra/ner/models.py` are immutable and enforce ingestion ordering, aligning with the canonical contract.
- Pipeline context handling centralises snippet logic in `filtra/utils/text.py`, and normalization sanitises logs to avoid leaking raw text.
- Orchestration merges per-document occurrences deterministically and reassigns ingestion indices before normalization, keeping downstream ordering stable.

### Acceptance Criteria Coverage
- AC1 – Verified via new models (`filtra/ner/models.py`) and alias compatibility test (`tests/ner/test_models.py::test_entities_alias_reflects_canonical_entities`).
- AC2 – Context snippet helper and pipeline population covered by `tests/ner/test_text_utils.py` and `tests/test_ner_pipeline.py` fixtures.
- AC3 – Deterministic grouping and logging validated in `tests/ner/test_models.py::test_normalize_entities_orders_by_ingestion_then_display` and `tests/test_normalization.py::test_normalize_entities_deduplicates_and_applies_aliases`.
- AC4 – Orchestrator merge and normalization flow exercised in `tests/test_cli.py::test_run_pipeline_logs_cache_and_proxy_environment`.
- AC5 – Unit and integration coverage expanded under `tests/ner/` plus updated integration suites.

### Tests Executed
- `pytest tests/ner/test_text_utils.py tests/ner/test_models.py tests/test_ner_pipeline.py tests/test_normalization.py tests/test_cli.py` (35 passed, 1 skipped smoke guard).

### Findings
- No blocking issues identified.
- Residual risk: real Hugging Face smoke remains skipped unless `FILTRA_ENABLE_SMOKE` is set; monitor when enabling pipeline execution.

### Recommendations
- Recommend story status proceed to Ready for Done once stakeholders review.