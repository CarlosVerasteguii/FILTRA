# Story 2.3: Entity Normalization & Dedup

## Status
Done

## Story
**As a** user,
**I want** clean, normalized entities,
**so that** the report avoids duplicates and alias noise.

## Acceptance Criteria
1. Apply casefolding, trimming, and alias map; language-agnostic normalization; output sorted lists.
2. Unit tests for alias normalization (e.g., "PyTorch" == "pytorch").
3. CLI flag or config to extend alias map without code changes.

## Tasks / Subtasks
- [x] Implement alias-aware normalization workflow that completes the entity extraction stage (AC: 1) [Source: architecture/components.md#entity-extraction--normalization-module][Source: docs/prd/requirements.md#13-fr13-the-tool-shall-normalize-and-de-duplicate-extracted-entities-before-rendering-the-report-including-casefolding-trimming-and-application-of-an-alias-map-normalization-should-be-language-agnostic-esen][Source: docs/prd/epic-2-core-extraction.md#story-23-entity-normalization--dedup]
  - [x] Extend `filtra/ner/normalization.py` to casefold, trim, and alias-map canonical names while preserving language-agnostic behavior and recording every transformation in the `normalization_log`. [Source: architecture/source-tree.md#source-tree][Source: architecture/tech-stack.md#extractedentitycollection][Source: architecture/tech-stack.md#aliasmap]
  - [x] Ensure the normalization step deduplicates entities per canonical key, sorts the resulting lists deterministically, and returns an updated `ExtractedEntityCollection` to the orchestrator. [Source: architecture/core-workflows.md#core-workflows][Source: architecture/high-level-architecture.md#high-level-overview]
- [x] Wire normalization output through orchestration and reporting flows (AC: 1) [Source: architecture/components.md#execution-orchestrator][Source: architecture/components.md#report-composition-layer][Source: architecture/components.md#configuration--persistence-layer]
  - [x] Invoke the normalization routines within the NER pipeline before scoring/reporting, ensuring downstream consumers only receive canonical entities. [Source: architecture/core-workflows.md#core-workflows][Source: architecture/coding-standards.md#coding-standards]
  - [x] Update logging to include concise normalization summaries without exposing raw resume content, aligned with existing error-handling patterns. [Source: architecture/error-handling-strategy.md#error-handling-patterns][Source: architecture/coding-standards.md#critical-rules]
- [x] Provide user-extensible alias configuration (AC: 3) [Source: architecture/components.md#cli-command-layer][Source: architecture/components.md#configuration--persistence-layer][Source: docs/prd/epic-2-core-extraction.md#story-23-entity-normalization--dedup]
  - [x] Add a CLI flag and complementary configuration loader path that merges a user-supplied alias map with the default `config/alias_map.yaml`, including validation and helpful error messaging. [Source: architecture/source-tree.md#source-tree][Source: architecture/tech-stack.md#aliasmap][Source: architecture/coding-standards.md#coding-standards]
  - [x] Document the new option in CLI help output and ensure warm-up diagnostics surface the active alias map configuration. [Source: architecture/components.md#diagnostics--warmup-service][Source: architecture/components.md#cli-command-layer]
- [x] Deliver normalization-focused tests (AC: 2) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/test-strategy-and-standards.md#integration-tests][Source: docs/prd/epic-2-core-extraction.md#story-23-entity-normalization--dedup]
  - [x] Add unit tests covering alias equivalence, casefolding, trimming, deduplication, and sorting for both Spanish and English fixtures under `tests/` mirroring the package structure. [Source: architecture/source-tree.md#source-tree][Source: architecture/test-strategy-and-standards.md#test-data-management]
  - [x] Extend integration tests to assert that orchestrated runs emit normalized, deduplicated sections and that CLI overrides for the alias map propagate correctly. [Source: architecture/core-workflows.md#core-workflows][Source: architecture/test-strategy-and-standards.md#integration-tests]

## Dev Notes
### Previous Story Insights
- Story 2.2 introduced the multilingual NER pipeline and returns `ExtractedEntityCollection` instances that expect normalization before scoring, so this story should build on that output without duplicating model loading concerns. [Source: docs/stories/2.2.multilingual-ner-cpu-only.md#dev-notes]
- The prior work already wired language profiles and proxy-aware logging; normalization must respect those structures and avoid regressing them. [Source: docs/stories/2.2.multilingual-ner-cpu-only.md#dev-notes]

### Data Models
- `ExtractedEntityCollection` supplies ordered entities, stores a normalization log, and is the artifact passed into scoring and reporting; normalization must update the canonical entities and log entries. [Source: architecture/tech-stack.md#extractedentitycollection]
- `AliasMap` defines canonical-to-alias relationships plus optional locale overrides, forming the authoritative source for deduplication. [Source: architecture/tech-stack.md#aliasmap]
- `LanguageProfile` contains detected and user-specified locales that normalization should treat in a language-agnostic manner. [Source: architecture/tech-stack.md#languageprofile]

### API Specifications
- The execution orchestrator calls normalization inside the entity extraction stage before handing data to scoring, so any new interfaces should remain internal to that flow. [Source: architecture/core-workflows.md#core-workflows]
- Configuration loading occurs through the persistence layer utilities that expose `load_alias_map()`, which should accept merged inputs without changing the public CLI surface beyond the new flag. [Source: architecture/components.md#configuration--persistence-layer]

### Component Specifications
- The Entity Extraction & Normalization module is responsible for applying alias rules and persisting transformation logs while staying CPU-only. [Source: architecture/components.md#entity-extraction--normalization-module]
- Diagnostics & Warmup should continue to call into the normalization module when prefetching models, so any new alias map options must integrate with those checks. [Source: architecture/components.md#diagnostics--warmup-service]

### File Locations
- Core normalization logic lives in `filtra/ner/normalization.py`, with CLI entry points in `filtra/cli.py` and orchestration glue under `filtra/orchestration/runner.py`. [Source: architecture/source-tree.md#source-tree]
- Alias configuration defaults reside in `config/alias_map.yaml`, and tests should mirror packages under `tests/` (e.g., `tests/test_ner_pipeline.py` or a new normalization-focused module). [Source: architecture/source-tree.md#source-tree]

### Testing Requirements
- Normalization code is part of the modules targeted for 100% coverage, requiring comprehensive unit tests plus targeted integration checks driven by pytest. [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/test-strategy-and-standards.md#integration-tests]
- Test fixtures should remain anonymized and stored in version-controlled files under `tests/fixtures/`, with deterministic assertions for alias behavior. [Source: architecture/test-strategy-and-standards.md#test-data-management]
- Execute CLI-led integration flows to confirm deduplicated, canonical entities and verify the alias override flag propagates end-to-end. [Source: architecture/test-strategy-and-standards.md#integration-tests]

## Testing
- Run `coverage run -m pytest` to cover normalization unit and integration suites, meeting the 100% coverage target for touched modules. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Ensure ES/EN fixtures under `tests/fixtures/` remain deterministic for alias equivalence scenarios and mirror the package structure. [Source: architecture/test-strategy-and-standards.md#test-data-management]
- Execute CLI-led integration flows to confirm deduplicated, canonical entities and verify the alias override flag propagates end-to-end. [Source: architecture/test-strategy-and-standards.md#integration-tests]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
- filtra/configuration/alias_map.py
- filtra/ner/normalization.py
- tests/test_normalization.py

## QA Results
- 2025-09-29: Risk profile captured at docs/qa/assessments/2.3-risk-20250929.md (score 65/100; 3 high, 1 medium).
- 2025-09-30: Gate review PASS recorded at docs/qa/gates/2.3-entity-normalization-and-dedup.yml.

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Alias map merging now guards canonical and alias collisions via registry lookups, so user overrides cannot silently replace canonical labels (filtra/configuration/alias_map.py:197-305). Normalization logs pass through hash-based sanitization, keeping resume strings redacted while preserving traceability (filtra/ner/normalization.py:29-99). CLI and warm-up outputs surface merged alias coverage and associated tests exercise the new flows end-to-end (filtra/cli.py:136-176, tests/test_cli.py:1-213).

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (`pytest tests/test_normalization.py tests/test_cli.py tests/test_ner_pipeline.py` — 30 passed, 1 skipped)
- All ACs Met: ✓

### Improvements Checklist
- [x] Detect and warn on alias map entries that redefine an existing canonical term with a different target (filtra/configuration/alias_map.py:197-305)
- [x] Scrub or hash raw entity text before appending to normalization logs (filtra/ner/normalization.py:29-99)

### Security Review
Normalization logs mask entity text with deterministic hashes, eliminating raw resume data exposure (filtra/ner/normalization.py:88-99).

### Performance Considerations
Deduplication runs in O(n) using hashed lookups; no bottlenecks observed for expected sizes.

### Files Modified During Review
- None

### Gate Status
Gate: PASS → docs/qa/gates/2.3-entity-normalization-and-dedup.yml
Risk profile: docs/qa/assessments/2.3-risk-20250929.md

### Recommended Status
✓ Approved – Ready to proceed


