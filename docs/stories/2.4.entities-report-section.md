# Story 2.4: Entities Report Section

## Status

Done

## Story

**As a** user,

**I want** a clear entities section in the terminal output,

**so that** I can quickly scan skills and companies.

## Acceptance Criteria

1. Render Skills and Companies tables using canonical entity aggregates, with default layout remaining ASCII-only and ~100 columns wide.

2. When the CLI is invoked with `--wide`, include the sources column and adjust wrapping to fit the expanded table; empty states display graceful placeholders.

3. Quiet mode prints only the final entities section plus these essential status lines (in order) while suppressing intermediate progress logs: "filtra quiet run: entities report ready", "Skills entries: {skills_count} | Companies entries: {companies_count}", and "Exit code: {exit_code}".

4. Reporting functions without scoring or LLM output and reuses evaluation labels/localization.

## Tasks / Subtasks

- [x] Render default Skills and Companies tables from canonical aggregates with the existing ASCII layout (~100 cols) and evaluation labels/localization hooks (AC: 1,4) [Source: docs/architecture/tech-stack.md#canonicalentity][Source: docs/architecture/tech-stack.md#reportenvelope][Source: docs/prd/user-interface-design-goals-cli-ux.md#core-screens-and-views]

  - [x] Populate table rows using ordered contexts, occurrence counts, and top confidence supplied in the canonical entities while respecting language profile labels (AC: 1,4) [Source: docs/architecture/tech-stack.md#languageprofile][Source: docs/architecture/components.md#report-composition-layer]

  - [x] Enforce ASCII-only characters, ~100 column width, and placeholder rows when the aggregate set is empty using the exact placeholders '-- no skills extracted --' and '-- no companies detected --' (AC: 1,2) [Source: docs/prd/user-interface-design-goals-cli-ux.md#key-interaction-paradigms][Source: docs/architecture/coding-standards.md#coding-standards]

- [x] Extend wide-mode rendering to add the sources column and adjust wrapping without breaking canonical ordering (AC: 2) [Source: docs/architecture/components.md#report-composition-layer][Source: docs/architecture/core-workflows.md#entity-processing-flow]

  - [x] Hydrate wide rows with ordered sources and snippets from canonical entities while adjusting column widths based on 'render_options["wide"]' (AC: 2) [Source: docs/architecture/tech-stack.md#canonicalentity][Source: docs/architecture/tech-stack.md#reportenvelope]

  - [x] Display graceful empty-state messages in wide mode when no sources are available (AC: 2) [Source: docs/prd/user-interface-design-goals-cli-ux.md#key-interaction-paradigms]

- [x] Ensure quiet mode emits only essential status lines plus the entities section while suppressing progress logs (AC: 3) [Source: docs/architecture/components.md#cli-command-layer][Source: docs/architecture/coding-standards.md#coding-standards]

  - [x] Verify orchestrator and report compositor deliver deterministic entities output to quiet runs without leaking intermediate logging (AC: 3) [Source: docs/architecture/core-workflows.md#entity-processing-flow][Source: docs/architecture/components.md#execution-orchestrator]

- [x] Support standalone entities reporting when scoring or LLM artefacts are absent while reusing evaluation labels/localization (AC: 4) [Source: docs/architecture/core-workflows.md#entity-processing-flow][Source: docs/architecture/tech-stack.md#reportenvelope]

  - [x] Guard rendering paths so missing scorecard or LLM analysis fall back to canonical entities and language defaults without raising errors (AC: 4) [Source: docs/architecture/tech-stack.md#evaluationrun][Source: docs/architecture/tech-stack.md#languageprofile]

- [x] Deliver renderer and CLI test coverage for default, wide, quiet, empty-state, and degraded-report scenarios (AC: 1,2,3,4) [Source: docs/architecture/test-strategy-and-standards.md#quiet-and-wide-modes][Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

  - [x] Add unit tests under tests/reporting/ for default and wide table formatting plus placeholder behaviours (AC: 1,2) [Source: docs/architecture/source-tree.md#source-tree][Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

  - [x] Extend CLI integration tests to confirm quiet output suppression and standalone entities reporting without scoring/LLM data (AC: 3,4) [Source: docs/architecture/test-strategy-and-standards.md#integration-tests][Source: docs/architecture/components.md#cli-command-layer]

## Project Structure Notes

- Reporting logic lives in 'filtra/reporting/composer.py' and 'filtra/reporting/renderer.py', with CLI toggles wired through 'filtra/cli.py'; keep new helpers within these packages. [Source: docs/architecture/source-tree.md#source-tree]

- Tests must mirror the package layout in 'tests/reporting/' and 'tests/test_cli.py', extending existing fixtures for quiet and wide modes. [Source: docs/architecture/source-tree.md#source-tree]

## Dev Notes

### Previous Story Insights

- Story 2.4a delivered canonical entity dataclasses with ingestion order, context snippets, and alias compatibility; reuse those structures when rendering tables. [Source: docs/stories/2.4a.entities-canonical-model.md#dev-notes]

- Story 2.4b added '--wide' and quiet CLI flags plus reporting scaffolding; align with its logging and renderer contracts rather than reintroducing flag plumbing. [Source: docs/stories/2.4b.cli-reporting-modes.md#dev-notes]

### Data Models

- 'EntityOccurrence' preserves raw text, spans, document metadata, snippets, and language codes for each mention. [Source: docs/architecture/tech-stack.md#entityoccurrence]

- 'CanonicalEntity' aggregates occurrences, exposes ordered contexts/sources, and tracks counts and confidence for table rows. [Source: docs/architecture/tech-stack.md#canonicalentity]

- 'ExtractedEntityCollection' bundles canonical entities, legacy aliases, language profile, and normalization log for reporting consumers. [Source: docs/architecture/tech-stack.md#extractedentitycollection]

### API Specifications

- Typer-based CLI exposes 'run' and 'warm_up' entry points that forward quiet/wide flags to the orchestrator. [Source: docs/architecture/components.md#cli-command-layer]

- Execution orchestrator returns a 'ReportEnvelope' composed from canonical entities, scoring, and LLM outputs for rendering. [Source: docs/architecture/components.md#execution-orchestrator]

### Component Specifications

- Report Composition Layer merges rubric metrics, LLM narratives, and canonical entities into terminal sections with quiet/wide awareness. [Source: docs/architecture/components.md#report-composition-layer]

- Entity Extraction & Normalization module already emits canonical entities with ordered contexts, so reporting should consume that contract directly. [Source: docs/architecture/components.md#entity-extraction--normalization-module]

### Empty State UX

- Use the placeholders '-- no skills extracted --' and '-- no companies detected --' for empty Skills/Companies tables in both default and wide layouts so tests can assert the exact strings.

### File Locations

- Renderer/composer modules reside under 'filtra/reporting/', with orchestrator logic in 'filtra/orchestration/runner.py' and CLI flags in 'filtra/cli.py'. [Source: docs/architecture/source-tree.md#source-tree]

### Testing Requirements

- Quiet and wide behaviours demand resilient CLI integration tests and renderer unit tests to avoid brittle width assertions. [Source: docs/architecture/test-strategy-and-standards.md#quiet-and-wide-modes]

- Organise tests with pytest mirroring package structure and using pytest-mock as needed. [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

- Integration suites should assert deterministic entities output even when scoring or LLM artefacts are absent. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]

### Technical Constraints

- Only the reporting layer may print to stdout; uphold quiet mode logging discipline. [Source: docs/architecture/coding-standards.md#coding-standards]

- Maintain ASCII-only output, ~100 column default width, and PowerShell-friendly readability. [Source: docs/prd/user-interface-design-goals-cli-ux.md#accessibility]

- Ensure entity reporting continues to pass through alias-normalised data before rendering. [Source: docs/architecture/coding-standards.md#critical-rules]

### Localization

- Continue using the language profile defaults and effective locale from 'ReportEnvelope.render_options' when formatting labels. [Source: docs/architecture/tech-stack.md#languageprofile][Source: docs/architecture/tech-stack.md#reportenvelope]

## Testing

- Add renderer unit tests covering default and wide layouts, placeholder rows, and ASCII width helpers under tests/reporting/. [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

- Extend CLI integration tests to validate quiet suppression and final entities output in both default and wide modes, including degraded runs with missing scoring/LLM data. [Source: docs/architecture/test-strategy-and-standards.md#quiet-and-wide-modes]

- Update or add regression fixtures to confirm localisation labels persist when only canonical entities are available. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]

## Change Log

| Date | Version | Description | Author |

| ---- | ------- | ----------- | ------ |

## Dev Agent Record

### Agent Model Used

- OpenAI GPT-5 (Codex CLI)

### Debug Log References

- py -3.10 -m pytest tests/reporting/test_entities_report.py tests/test_cli.py

### Completion Notes List

- Implemented dual-table entities renderer with localization-aware labels, placeholders, and expanded wide-mode sources.
- Wired orchestrator envelope language profile through CLI and added quiet-mode status lines with category counts.
- Added renderer unit coverage plus refreshed CLI tests for default, wide, quiet, and degraded scenarios.

### File List

- filtra/reporting/renderer.py
- filtra/orchestration/runner.py
- filtra/cli.py
- tests/reporting/test_entities_report.py
- tests/test_cli.py

## QA Results

### Review Date: 2025-10-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- PASS: Renderer groups canonical skills/companies with consistent placeholders and tip guidance, keeping default/wide layouts aligned with aggregates (filtra/reporting/renderer.py:51).
- PASS: Quiet CLI path now suppresses progress logs while emitting only the mandated status lines plus the rendered entities section (filtra/cli.py:315).
- FAIL: Output is not coerced to ASCII; `_pad_text` and `_normalize_text` pass UTF-8 contexts and entity labels straight through, so accented characters from resumes (e.g., “développeur”) will leak into the default layout, violating the ASCII-only acceptance criteria (filtra/reporting/renderer.py:161,183).

### Acceptance Criteria Traceability
- AC1 (default tables, ASCII width, placeholders): behaviour satisfied for structure/width/placeholders, but ASCII constraint fails as noted above. Validated via `test_render_entities_report_default_layout` and `test_render_entities_report_empty_sections`.
- AC2 (wide mode with sources, graceful empty states): PASS – sources column and wrapping confirmed through renderer and CLI tests (`test_render_entities_report_wide_includes_sources`, `test_run_wide_flag_includes_sources_column`).
- AC3 (quiet mode output discipline): PASS – quiet run emits ordered status lines and no summary logs (`test_quiet_flag_suppresses_info_logs`).
- AC4 (standalone entities reporting without scoring/LLM, localization reuse): PASS – pipeline builds report envelopes even when other artefacts are absent, and localization hooks remain intact (filtra/orchestration/runner.py:124,270).

### Tests Executed
- `./.venv/Scripts/python.exe -m pytest tests/reporting/test_entities_report.py tests/test_cli.py`

### Recommendation
- Gate decision: FAIL – enforce ASCII sanitization in the renderer before moving to Done.

### Review Date: 2025-10-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- PASS: `_normalize_text` now applies NFKD folding and ASCII encoding before padding, so entity names, contexts, and sources remain ASCII-only across layouts (filtra/reporting/renderer.py:118-135).
- PASS: Wide-mode sources reuse the shared normalizer, ensuring consistency between default and expanded renders (filtra/reporting/renderer.py:148-172).
- NOTE: Localization labels delivered through external language profiles still bypass normalization; acceptable for now because the default profile remains ASCII, but flag for future multilingual audits.

### Acceptance Criteria Traceability
- AC1 (default tables, ASCII width, placeholders): PASS – renderer enforces ASCII sanitization and preserves ~100 column layout; validated via `test_render_entities_report_default_layout` and the new `test_render_entities_report_sanitizes_non_ascii_characters`.
- AC2 (wide mode with sources, graceful empty states): PASS – sources column formatting confirmed with sanitization applied (`test_render_entities_report_wide_includes_sources`).
- AC3 (quiet mode output discipline): PASS – CLI integration tests retain required status lines without extra logs (`tests/test_cli.py::test_quiet_flag_suppresses_info_logs`).
- AC4 (standalone entities reporting without scoring/LLM, localization reuse): PASS – degraded-path fallbacks still flow through canonical entities (`filtra/orchestration/runner.py:124,270`).

### Tests Executed
- `./.venv/Scripts/python.exe -m pytest tests/reporting/test_entities_report.py tests/test_cli.py`

### Recommendation
- Gate decision: PASS – renderer meets ASCII requirement and all criteria now satisfied; recommend status "Ready for Done" while monitoring localized label coverage in future stories.
