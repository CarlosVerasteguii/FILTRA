# Story 1.3: Warm-up Command

## Status
Done

## Story
**As a** user,
**I want** a warm-up command,
**so that** first demo run does not incur downloads or cold failures.

## Acceptance Criteria
1. `filtra warm-up` pre-downloads the selected NER model to cache and verifies OpenRouter connectivity with a lightweight request.
2. Prints cache location and approximate on-disk size; respects proxy env vars.
3. Completes under 120 seconds on typical connection or exits with clear guidance.
4. Automated unit and integration tests assert the CLI exit codes for warm-up success and failure paths.

## Tasks / Subtasks
- [x] Wire the `warm-up` Typer command to the diagnostics workflow so it consumes standard logging/quiet flags and shares CLI validation (AC: 1,2,3) [Source: architecture/components.md#cli-command-layer][Source: architecture/components.md#diagnostics--warmup-service]
  - [x] Reuse existing CLI option parsing to surface warm-up arguments and call the diagnostics entrypoint from `filtra/cli.py` (AC: 1,2) [Source: architecture/source-tree.md#source-tree][Source: architecture/components.md#cli-command-layer]
  - [x] Return structured exit codes by routing diagnostics exceptions through the orchestrator error handlers (AC: 3) [Source: architecture/error-handling-strategy.md#business-logic-errors][Source: architecture/components.md#execution-orchestrator]
- [x] Prime NER resources through the diagnostics service to avoid runtime downloads (AC: 1,2) [Source: architecture/components.md#diagnostics--warmup-service][Source: architecture/core-workflows.md#core-workflows]
  - [x] Invoke the entity extraction module's `warm_cache` with the configured multilingual model and alias map to populate the HF cache (AC: 1) [Source: architecture/components.md#entity-extraction--normalization-module][Source: architecture/tech-stack.md#technology-stack-table]
  - [x] Inspect the HuggingFace cache directory and report status using Windows-friendly paths (AC: 2) [Source: architecture/tech-stack.md#technology-stack-table][Source: architecture/source-tree.md#source-tree]
- [x] Perform a dry-run OpenRouter health check via the LLM gateway to verify connectivity (AC: 1,3) [Source: architecture/components.md#llm-integration-gateway][Source: architecture/external-apis.md#openrouter-api]
  - [x] Apply the warm-up-specific timeout (5s total) and retry policy so failures exit quickly with actionable remediation (AC: 3) [Source: architecture/error-handling-strategy.md#external-api-errors][Source: architecture/error-handling-strategy.md#general-approach]
  - [x] Honor proxy environment variables (`HTTPS_PROXY`, `HTTP_PROXY`, `NO_PROXY`) and document which endpoints were reachable (AC: 2,3) [Source: architecture/security.md#api-security][Source: architecture/security.md#authentication--authorization]
- [x] Produce a readiness summary covering cache size, locations, and secrets without leaking sensitive values (AC: 2,3) [Source: architecture/components.md#diagnostics--warmup-service][Source: architecture/security.md#secrets-management]
  - [x] Compute approximate cache size and elapsed warm-up duration, flagging when work exceeds 120 seconds (AC: 2,3) [Source: architecture/infrastructure-and-deployment.md#deployment-strategy][Source: architecture/error-handling-strategy.md#general-approach]
  - [x] Surface required environment prerequisites (Python version, `OPENROUTER_API_KEY`, proxy status) with remediation text that keeps stdout limited to the reporting layer (AC: 2,3) [Source: architecture/coding-standards.md#critical-rules][Source: architecture/security.md#authentication--authorization]
- [x] Extend automated coverage for the warm-up workflow (AC: 1,2,3) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [x] Add CLI unit tests verifying the warm-up command wiring, output formatting, and quiet mode behaviour using mocked diagnostics responses (AC: 1,2) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/source-tree.md#source-tree]
  - [x] Create integration tests with mocked OpenRouter responses to validate retry/timeout handling and remediation messaging (AC: 1,3) [Source: architecture/test-strategy-and-standards.md#integration-tests][Source: architecture/external-apis.md#openrouter-api]
- [x] Refresh Windows-facing documentation and scripts to reflect the warm-up flow (AC: 2) [Source: architecture/infrastructure-and-deployment.md#deployment-strategy][Source: architecture/source-tree.md#source-tree]
  - [x] Update README and `scripts/warmup_demo.ps1` with cache output examples and troubleshooting tips tied to the diagnostics service (AC: 2) [Source: architecture/coding-standards.md#core-standards][Source: architecture/components.md#diagnostics--warmup-service]

## Dev Notes
### Previous Story Insights
- Diagnostics and warm-up responsibilities already exist in the architecture; the new command must reuse the shared service to stay consistent with the `--health` checks. [Source: architecture/components.md#diagnostics--warmup-service]
- Orchestrator error mapping ensures CLI commands exit with deterministic codes; warm-up failures should pass through the same handlers for AC3 messaging. [Source: architecture/error-handling-strategy.md#business-logic-errors]
- Evaluation metadata links WarmupResult records to later reporting, so diagnostics output should populate those structures for reuse. [Source: architecture/tech-stack.md#evaluationrun]

### Data Models
- `WarmupResult` captures model cache status, API health, and timing metrics that must be returned by the diagnostics service. [Source: architecture/components.md#diagnostics--warmup-service]
- `EvaluationRun` bundles CLI options and references WarmupResult when preflight checks run before execution. [Source: architecture/tech-stack.md#evaluationrun]

### API Specifications
- OpenRouter connectivity is validated via `POST /api/v1/chat/completions` using Bearer auth, referer, and title headers; warm-up should issue a lightweight request through the LLM gateway. [Source: architecture/external-apis.md#openrouter-api]

### Component Specifications
- Typer CLI exposes `run` and `warm-up` subcommands that hand off to orchestrator and diagnostics layers. [Source: architecture/components.md#cli-command-layer]
- Diagnostics & Warmup Service prefetches models, checks API access, and summarizes readiness; it returns WarmupResult for reporting. [Source: architecture/components.md#diagnostics--warmup-service]
- Entity Extraction module provides `warm_cache` to load HuggingFace weights before runtime. [Source: architecture/components.md#entity-extraction--normalization-module]
- The core workflow diagram shows warm-up invoking language utilities, NER warm cache, and LLM health checks before reporting status. [Source: architecture/core-workflows.md#core-workflows]

### File Locations
- CLI entrypoint logic resides in `filtra/cli.py`, while warm-up orchestration hooks belong in `filtra/orchestration/warmup.py`. [Source: architecture/source-tree.md#source-tree]
- Warm-up demos live in `scripts/warmup_demo.ps1`, and CLI unit tests continue in `tests/test_cli.py` with integration suites under `tests/integration/`. [Source: architecture/source-tree.md#source-tree]

### Testing Requirements
- Use pytest with pytest-mock to cover CLI wiring, cache prefetch, and proxy/env handling, keeping module coverage at or above 85%. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Integration tests should mock OpenRouter responses and reuse cached models to validate retries without network dependence. [Source: architecture/test-strategy-and-standards.md#integration-tests]

### Technical Constraints
- Only the reporting layer may write to stdout/stderr; diagnostics code should return data structures and let CLI formatting handle output. [Source: architecture/coding-standards.md#critical-rules]
- Warm-up calls use a 5-second HTTP timeout with tenacity retries to keep overall execution under the 120-second budget. [Source: architecture/error-handling-strategy.md#external-api-errors]
- Proxy variables must be respected, and secrets like `OPENROUTER_API_KEY` must never be echoed in logs. [Source: architecture/security.md#api-security][Source: architecture/security.md#secrets-management]
- Windows-first support and the default `es-MX` locale should remain intact when reporting readiness details. [Source: architecture/tech-stack.md#technology-stack-table]

### Project Structure Notes
- Keep new warm-up logic within existing CLI and orchestration packages to maintain the documented source tree layout. [Source: architecture/source-tree.md#source-tree]

### Testing
- Follow Arrange/Act/Assert structure, mock external HTTP via `httpx.MockTransport`, and document warm-up fixtures for reproducibility. [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Change Log
| Date       | Version | Description           | Author |
| ---------- | ------- | --------------------- | ------ |
| 2025-09-26 | 0.1     | Initial draft created | Bob    |
| 2025-09-26 | 0.2     | Masked proxy output and cleaned __pycache__ | James  |
| 2025-09-26 | 0.3     | Hardened PowerShell helper and README example to hide proxy secrets | James  |
| 2025-09-26 | 0.4     | Added torch dependency and fixed warm-up demo invocation | James  |

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex

### Debug Log References
- python -m pytest

### Completion Notes List
- Wired the warm-up Typer command into the diagnostics workflow with shared logging, error mapping, and reporting helpers.
- Implemented NER cache priming, OpenRouter health checks, proxy awareness, and readiness summarisation via `WarmupResult`.
- Added CLI and integration tests plus README/script updates documenting the warm-up flow.
- Masked proxy environment output to prevent credential leakage in warm-up diagnostics.
- Removed tracked __pycache__ directories from the repository for a clean tree.
- Hardened the PowerShell warm-up helper to hide proxy credentials and refreshed the README example to match the secured output.
- Added torch dependency to ensure the warm-up workflow installs NER weights and fixed the PowerShell invocation for python.exe compatibility.

### File List
- requirements.in
- requirements.txt
- README.md
- filtra/cli.py
- filtra/llm/__init__.py
- filtra/llm/client.py
- filtra/ner/__init__.py
- filtra/ner/pipeline.py
- filtra/orchestration/__init__.py
- filtra/orchestration/diagnostics.py
- filtra/orchestration/runner.py
- filtra/orchestration/warmup.py
- scripts/warmup_demo.ps1
- tests/test_cli.py
- tests/test_warmup.py

## QA Results
- **Decision: PASS** – Warm-up diagnostics, documentation, and helper tooling now protect proxy secrets and satisfy AC2 alongside the previously met criteria.
- **Findings**
  1. Warm-up output masks proxy variables by emitting status strings only, preventing credential exposure (filtra/cli.py:127).
  2. README warm-up walkthrough documents masked proxy values and reiterates secret-safety guidance (README.md:65).
  3. PowerShell warm-up helper hides proxy environment values while preserving demo guidance (scripts/warmup_demo.ps1:33).
  4. Torch runtime dependency is pinned in requirements manifests, ensuring transformers-based warm-up succeeds out of the box (requirements.in:19, requirements.txt:152).
- **Testing**
  - Not re-run; static analysis only (pytest unavailable in reviewer environment).

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Warm-up CLI rendering now delegates masked proxy output and remains covered by tests/test_cli.py::test_warmup_command_renders_summary and tests/test_cli.py::test_warmup_command_respects_quiet.
- README and PowerShell helper align with diagnostics messaging, keeping proxy secrets hidden while guiding operators.
- Requirements pin torch to align with transformers usage; no extraneous dependencies introduced.
- Test suite still needs to be executed locally (`pytest`) because the shared reviewer environment lacks the tooling to run it.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ Output honours security guidance by masking proxy secrets.
- Project Structure: ✓ Files remain within documented packages and follow source-tree guidance.
- Testing Strategy: △ CLI masking behaviour covered; add future regression coverage around PowerShell helper if feasible.
- All ACs Met: ✓ AC2 now satisfied after documentation and script updates.

### Improvements Checklist
- [x] Mask proxy environment values in scripts/warmup_demo.ps1 and align messaging with diagnostics output.
- [x] Update README.md warm-up example to reflect masked proxy status and call out credential safety.
- [ ] Add regression coverage ensuring warm-up utilities never emit raw proxy credentials (CLI and scripts).

### Security Review
- Medium severity concern addressed: supporting assets now hide proxy credential values.

### Performance Considerations
- No new performance risks observed; duration cap and retry policy behave as specified.

### Files Modified During Review
- None (review only).

### Gate Status
Gate: PASS → docs/qa/gates/1.3-warm-up-command.yml
Risk profile: Not generated for this review
NFR assessment: Not generated for this review

### Recommended Status
[✓ Ready for Release]
