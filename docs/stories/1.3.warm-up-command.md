# Story 1.3: Warm-up Command

## Status
Draft

## Story
**As a** user,
**I want** a warm-up command,
**so that** first demo run does not incur downloads or cold failures.

## Acceptance Criteria
1. `filtra warm-up` pre-downloads the selected NER model to cache and verifies OpenRouter connectivity with a lightweight request.
2. Prints cache location and approximate on-disk size; respects proxy env vars.
3. Completes under 120 seconds on typical connection or exits with clear guidance.
4. Automated unit and integration tests assert the CLI exit codes for warm-up success and failure paths.

## Tasks / Subtasks
- [ ] Wire the `warm-up` Typer command to the diagnostics workflow so it consumes standard logging/quiet flags and shares CLI validation (AC: 1,2,3) [Source: architecture/components.md#cli-command-layer][Source: architecture/components.md#diagnostics--warmup-service]
  - [ ] Reuse existing CLI option parsing to surface warm-up arguments and call the diagnostics entrypoint from `filtra/cli.py` (AC: 1,2) [Source: architecture/source-tree.md#source-tree][Source: architecture/components.md#cli-command-layer]
  - [ ] Return structured exit codes by routing diagnostics exceptions through the orchestrator error handlers (AC: 3) [Source: architecture/error-handling-strategy.md#business-logic-errors][Source: architecture/components.md#execution-orchestrator]
- [ ] Prime NER resources through the diagnostics service to avoid runtime downloads (AC: 1,2) [Source: architecture/components.md#diagnostics--warmup-service][Source: architecture/core-workflows.md#core-workflows]
  - [ ] Invoke the entity extraction module's `warm_cache` with the configured multilingual model and alias map to populate the HF cache (AC: 1) [Source: architecture/components.md#entity-extraction--normalization-module][Source: architecture/tech-stack.md#technology-stack-table]
  - [ ] Inspect the HuggingFace cache directory and report status using Windows-friendly paths (AC: 2) [Source: architecture/tech-stack.md#technology-stack-table][Source: architecture/source-tree.md#source-tree]
- [ ] Perform a dry-run OpenRouter health check via the LLM gateway to verify connectivity (AC: 1,3) [Source: architecture/components.md#llm-integration-gateway][Source: architecture/external-apis.md#openrouter-api]
  - [ ] Apply the warm-up-specific timeout (5s total) and retry policy so failures exit quickly with actionable remediation (AC: 3) [Source: architecture/error-handling-strategy.md#external-api-errors][Source: architecture/error-handling-strategy.md#general-approach]
  - [ ] Honor proxy environment variables (`HTTPS_PROXY`, `HTTP_PROXY`, `NO_PROXY`) and document which endpoints were reachable (AC: 2,3) [Source: architecture/security.md#api-security][Source: architecture/security.md#authentication--authorization]
- [ ] Produce a readiness summary covering cache size, locations, and secrets without leaking sensitive values (AC: 2,3) [Source: architecture/components.md#diagnostics--warmup-service][Source: architecture/security.md#secrets-management]
  - [ ] Compute approximate cache size and elapsed warm-up duration, flagging when work exceeds 120 seconds (AC: 2,3) [Source: architecture/infrastructure-and-deployment.md#deployment-strategy][Source: architecture/error-handling-strategy.md#general-approach]
  - [ ] Surface required environment prerequisites (Python version, `OPENROUTER_API_KEY`, proxy status) with remediation text that keeps stdout limited to the reporting layer (AC: 2,3) [Source: architecture/coding-standards.md#critical-rules][Source: architecture/security.md#authentication--authorization]
- [ ] Extend automated coverage for the warm-up workflow (AC: 1,2,3) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Add CLI unit tests verifying the warm-up command wiring, output formatting, and quiet mode behaviour using mocked diagnostics responses (AC: 1,2) [Source: architecture/test-strategy-and-standards.md#unit-tests][Source: architecture/source-tree.md#source-tree]
  - [ ] Create integration tests with mocked OpenRouter responses to validate retry/timeout handling and remediation messaging (AC: 1,3) [Source: architecture/test-strategy-and-standards.md#integration-tests][Source: architecture/external-apis.md#openrouter-api]
- [ ] Refresh Windows-facing documentation and scripts to reflect the warm-up flow (AC: 2) [Source: architecture/infrastructure-and-deployment.md#deployment-strategy][Source: architecture/source-tree.md#source-tree]
  - [ ] Update README and `scripts/warmup_demo.ps1` with cache output examples and troubleshooting tips tied to the diagnostics service (AC: 2) [Source: architecture/coding-standards.md#core-standards][Source: architecture/components.md#diagnostics--warmup-service]

## Dev Notes
### Previous Story Insights
- Diagnostics and warm-up responsibilities already exist in the architecture; the new command must reuse the shared service to stay consistent with the `--health` checks. [Source: architecture/components.md#diagnostics--warmup-service]
- Orchestrator error mapping ensures CLI commands exit with deterministic codes; warm-up failures should pass through the same handlers for AC3 messaging. [Source: architecture/error-handling-strategy.md#business-logic-errors]
- Evaluation metadata links WarmupResult records to later reporting, so diagnostics output should populate those structures for reuse. [Source: architecture/tech-stack.md#evaluationrun]

### Data Models
- `WarmupResult` captures model cache status, API health, and timing metrics that must be returned by the diagnostics service. [Source: architecture/components.md#diagnostics--warmup-service]
- `EvaluationRun` bundles CLI options and references WarmupResult when preflight checks run before execution. [Source: architecture/tech-stack.md#evaluationrun]

### API Specifications
- OpenRouter connectivity is validated via `POST /api/v1/chat/completions` using Bearer auth, referer, and title headers; warm-up should issue a lightweight request through the LLM gateway. [Source: architecture/external-apis.md#openrouter-api]

### Component Specifications
- Typer CLI exposes `run` and `warm-up` subcommands that hand off to orchestrator and diagnostics layers. [Source: architecture/components.md#cli-command-layer]
- Diagnostics & Warmup Service prefetches models, checks API access, and summarizes readiness; it returns WarmupResult for reporting. [Source: architecture/components.md#diagnostics--warmup-service]
- Entity Extraction module provides `warm_cache` to load HuggingFace weights before runtime. [Source: architecture/components.md#entity-extraction--normalization-module]
- The core workflow diagram shows warm-up invoking language utilities, NER warm cache, and LLM health checks before reporting status. [Source: architecture/core-workflows.md#core-workflows]

### File Locations
- CLI entrypoint logic resides in `filtra/cli.py`, while warm-up orchestration hooks belong in `filtra/orchestration/warmup.py`. [Source: architecture/source-tree.md#source-tree]
- Warm-up demos live in `scripts/warmup_demo.ps1`, and CLI unit tests continue in `tests/test_cli.py` with integration suites under `tests/integration/`. [Source: architecture/source-tree.md#source-tree]

### Testing Requirements
- Use pytest with pytest-mock to cover CLI wiring, cache prefetch, and proxy/env handling, keeping module coverage at or above 85%. [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Integration tests should mock OpenRouter responses and reuse cached models to validate retries without network dependence. [Source: architecture/test-strategy-and-standards.md#integration-tests]

### Technical Constraints
- Only the reporting layer may write to stdout/stderr; diagnostics code should return data structures and let CLI formatting handle output. [Source: architecture/coding-standards.md#critical-rules]
- Warm-up calls use a 5-second HTTP timeout with tenacity retries to keep overall execution under the 120-second budget. [Source: architecture/error-handling-strategy.md#external-api-errors]
- Proxy variables must be respected, and secrets like `OPENROUTER_API_KEY` must never be echoed in logs. [Source: architecture/security.md#api-security][Source: architecture/security.md#secrets-management]
- Windows-first support and the default `es-MX` locale should remain intact when reporting readiness details. [Source: architecture/tech-stack.md#technology-stack-table]

### Project Structure Notes
- Keep new warm-up logic within existing CLI and orchestration packages to maintain the documented source tree layout. [Source: architecture/source-tree.md#source-tree]

### Testing
- Follow Arrange/Act/Assert structure, mock external HTTP via `httpx.MockTransport`, and document warm-up fixtures for reproducibility. [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Change Log
| Date       | Version | Description           | Author |
| ---------- | ------- | --------------------- | ------ |
| 2025-09-26 | 0.1     | Initial draft created | Bob    |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
