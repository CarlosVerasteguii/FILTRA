# Story 2.4b: CLI Reporting Modes

## Status
Done

## Story
**As a** CLI user,
**I want** quiet and wide modes that align with the reporting specification,
**so that** I can control verbosity and layout without losing the final entities summary.

## Acceptance Criteria
1. Add a `--wide` flag surfaced in CLI help and warm-up output that toggles additional columns in the report renderer.
2. Quiet mode suppresses progress logs but still prints the final entities section unless an error occurs.
3. CLI help and documentation describe quiet and wide behavior with PowerShell-friendly examples and stay synchronized between Typer help, warm-up output, and README snippets.
4. Automated tests validate quiet output, wide column rendering, and help text updates while remaining resilient to layout adjustments (avoid brittle width assertions).

## Tasks / Subtasks
- [x] Wire quiet and wide options through CLI entry points (AC: 1,2,3) [Source: architecture/components.md#cli-command-layer][Source: architecture/core-workflows.md#entity-processing-flow]
  - [x] Add a `--wide` Typer option on the `run` subcommand and ensure quiet mode still routes the final entities section to stdout. (AC: 1,2)
  - [x] Update CLI help text and warm-up messaging to explain quiet and wide behaviors with PowerShell-friendly usage examples. (AC: 1,3)
- [x] Propagate quiet/wide toggles into reporting orchestration (AC: 1,2) [Source: architecture/core-workflows.md#entity-processing-flow][Source: architecture/components.md#report-composition-layer][Source: docs/prd/epic-2-core-extraction.md#story-24-entities-report-section]
  - [x] Extend the execution orchestrator to include quiet and wide flags in the report envelope/render options handoff. (AC: 1,2)
  - [x] Adjust reporting composer/renderer helpers so wide mode adds sources and default mode remains near 100 columns while still ASCII-only. (AC: 1) [Source: docs/prd/epic-2-core-extraction.md#story-24-entities-report-section]
- [x] Refresh documentation for CLI modes (AC: 3) [Source: architecture/components.md#cli-command-layer][Source: prd/user-interface-design-goals-cli-ux.md#windows-11-considerations]
  - [x] Document quiet and wide behavior in CLI help, README snippets, and warm-up output to highlight Windows Terminal usage. (AC: 3)
- [x] Expand automated coverage for quiet and wide behavior (AC: 4) [Source: architecture/test-strategy-and-standards.md#quiet-and-wide-modes][Source: architecture/coding-standards.md#core-standards]
  - [x] Add CLI integration tests that assert quiet suppresses progress logs yet keeps the entities summary and that wide renders the sources column. (AC: 4)
  - [x] Add unit coverage for any formatting helpers that govern quiet/wide layout logic. (AC: 4)

## Project Structure Notes
- CLI entry lives in `filtra/cli.py`, reporting helpers in `filtra/reporting/`, and CLI tests under `tests/test_cli.py` with additional reporting tests in `tests/reporting/`. This story aligns with the existing source tree; no conflicts detected. [Source: architecture/source-tree.md#source-tree]

## Dev Notes
### Previous Story Insights
- Reporting depends on canonical entities from Story 2.4a, and the architecture expects the CLI to pass quiet and wide toggles so the report composer can adjust layout while always emitting the final entities section. [Source: architecture/core-workflows.md#entity-processing-flow][Source: architecture/components.md#report-composition-layer]

### Data Models
- `EvaluationRun` captures CLI flags (including quiet and future width toggles) for traceability, ensuring render settings propagate consistently. [Source: architecture/tech-stack.md#evaluationrun]
- `ReportEnvelope.render_options` stores quiet and wide flags so the renderer can expand columns or suppress progress output deterministically. [Source: architecture/tech-stack.md#reportenvelope]

### API Specifications
- The CLI command layer exposes `run` and `warm_up` interfaces that must parse quiet/wide flags and forward them during execution. [Source: architecture/components.md#cli-command-layer]

### Component Specifications
- The Report Composition Layer merges canonical entities with CLI render options, expanding tables in wide mode while maintaining ASCII formatting. [Source: architecture/components.md#report-composition-layer]
- The CLI command layer is responsible for enforcing quiet output discipline while still printing the final report section. [Source: architecture/components.md#cli-command-layer]

### File Locations
- CLI options are defined in `filtra/cli.py`, orchestrator wiring in `filtra/orchestration/runner.py`, and reporting adjustments in `filtra/reporting/composer.py` and `filtra/reporting/renderer.py`; related tests live in `tests/test_cli.py` and `tests/reporting/test_entities_section.py`. [Source: architecture/source-tree.md#source-tree]

### Testing Requirements
- Tests must mirror package structure, using pytest-based unit tests and CLI integration coverage to validate quiet/wide behavior and deterministic ordering. [Source: architecture/test-strategy-and-standards.md#quiet-and-wide-modes]
- Reporting unit tests should exercise width-aware helpers to keep default output near 100 columns and validate wide-mode formatting, empty states, and localization fallbacks. [Source: architecture/test-strategy-and-standards.md#quiet-and-wide-modes]
- Maintain >=85% coverage and follow pytest conventions when adding new suites. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Technical Constraints
- Only the reporting layer may write to stdout/stderr; other modules must return data or raise structured errors, so quiet mode must explicitly route warnings/errors to stderr even when quiet mode suppresses progress logs. [Source: architecture/coding-standards.md#critical-rules]
- Quiet runs must still emit the final entities summary, and wide mode must expand columns while keeping the default layout ASCII-only and near 100 columns as defined in the reporting specification. [Source: architecture/components.md#report-composition-layer][Source: docs/prd/epic-2-core-extraction.md#story-24-entities-report-section]

## Testing
- Place CLI integration tests under `tests/test_cli.py` and reporting-specific tests under `tests/reporting/`, exercising quiet suppression, wide layout, and help text updates. [Source: architecture/source-tree.md#source-tree][Source: architecture/test-strategy-and-standards.md#quiet-and-wide-modes]
- Use pytest with fixtures/mocks to validate logging behavior while maintaining the >=85% coverage goal. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex

### Debug Log References
- `python -m pytest`

### Completion Notes List
- Added ``--wide`` option and ensured quiet runs still emit the canonical entities table.
- Introduced reporting renderers to project the canonical entities summary with optional source columns.
- Updated CLI help, warm-up messaging, README, and tests to cover quiet/wide behavior end-to-end.

### File List
- filtra/cli.py
- filtra/orchestration/runner.py
- filtra/reporting/__init__.py
- filtra/reporting/renderer.py
- tests/test_cli.py
- README.md

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation successfully delivers all acceptance criteria for CLI reporting modes. The code demonstrates excellent quality with:

- Clean separation of concerns between CLI options, orchestration, and rendering
- Proper propagation of `quiet` and `wide` flags through the execution pipeline
- ASCII-only table formatting with stable column widths
- Comprehensive test coverage validating both modes end-to-end

The developer has adhered to the project's coding standards, maintaining the "CLI output discipline" rule where only the reporting layer writes to stdout/stderr.

### Refactoring Performed

No refactoring was necessary. The implementation is clean, well-structured, and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Follows black formatting, proper imports, ASCII-only output
- Project Structure: ✓ Files in correct locations (cli.py, reporting/, tests/)
- Testing Strategy: ✓ CLI integration tests validate quiet/wide behavior with resilient assertions
- All ACs Met: ✓ All 4 acceptance criteria fully satisfied

### Improvements Checklist

All items have been addressed by the developer:

- [x] `--wide` flag implemented and surfaced in CLI help
- [x] Quiet mode suppresses progress logs while preserving entities output
- [x] Help text and documentation updated with PowerShell examples
- [x] Automated tests cover quiet suppression and wide column rendering
- [x] Default mode includes tip to use `--wide`
- [x] Wide mode adds Sources column and removes tip
- [x] Tests avoid brittle width assertions (use content checks instead)

### Security Review

No security concerns identified. The implementation:
- Does not expose sensitive data in the Sources column
- Properly sanitizes source strings before display
- Maintains proper error handling through quiet mode

### Performance Considerations

Performance is excellent:
- Table rendering is efficient with simple string operations
- No performance degradation from wide mode (just additional column)
- Quiet mode reduces log overhead as expected

### Files Modified During Review

No files were modified during review. All implementation was correct.

### Test Coverage Analysis

**Comprehensive test coverage validates:**

1. **Quiet Mode Behavior** (`test_quiet_flag_suppresses_info_logs`):
   - Verifies progress messages are suppressed
   - Confirms canonical entities section still appears
   - Validates logging level set to WARNING

2. **Wide Mode Behavior** (`test_run_wide_flag_includes_sources_column`):
   - Confirms Sources column appears in output
   - Verifies tip about `--wide` is removed in wide mode
   - Tests source data appears correctly

3. **Help Text Updates** (`test_run_help_mentions_wide`):
   - Validates `--wide` flag in run command help
   - Confirms descriptive help text is present

4. **Default Mode** (`test_run_executes_with_valid_files`):
   - Verifies tip about `--wide` appears in default mode
   - Confirms entities table renders properly

All 25 CLI tests pass, providing strong confidence in the implementation.

### Gate Status

Gate: PASS → docs/qa/gates/2.4b-cli-reporting-modes.yml
NFR assessment: docs/qa/assessments/2.4b-nfr-20250112.md
Trace matrix: docs/qa/assessments/2.4b-trace-20250112.md

### Recommended Status

✓ Ready for Done

The story is complete with all acceptance criteria met, comprehensive test coverage, and no issues identified.



